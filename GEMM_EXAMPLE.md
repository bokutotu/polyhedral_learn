---

## 1. パラメータ空間 $(P)$  
GEMM のループ境界 $(N, M, K)$ をパラメータとして扱います。  
$$
P = \{ (N,M,K)\in\mathbb{Z}^3 \mid N>0,\;M>0,\;K>0\}.
$$

---

## 2. 反復ドメイン $(D)$  
各反復ベクトル $\vec{x}=(i,j,k)$ が属する整数多面体です。  
$$
D = \{(i,j,k)\in\mathbb{Z}^3 \mid 0 \le i < N,\;0 \le j < M,\;0 \le k < K\}.
$$  
不等式で表すと：  
$$
\begin{cases}
i \ge 0,\\
j \ge 0,\\
k \ge 0,\\
-i + (N-1) \ge 0,\\
-j + (M-1) \ge 0,\\
-k + (K-1) \ge 0.
\end{cases}
$$

---

## 3. アクセス関数（アクセス多面体）  
メモリアクセスを線形写像として記述します。  
- $A[i,k]$ へのアクセス：$\vec{f}_A(i,j,k)=(i,k)$  
- $B[k,j]$ へのアクセス：$\vec{f}_B(i,j,k)=(k,j)$  
- $C[i,j]$ へのアクセス：$\vec{f}_C(i,j,k)=(i,j)$  

---

## 4. 依存多面体 $(R)$  
ある反復での書き込み／読み込みが同一アドレスを参照する対 $(\vec{x},\vec{x}')$ の集合。  
GEMM では累積加算のため、同一 $(i,j)$ 上で $k$ が増加する方向に真の依存（RAW）が生じます。  

$$
R_{\mathrm{true}}
=
\bigl\{\,((i,j,k),(i',j',k'))\in D\times D \mid
i=i',\;j=j',\;k+1=k'\bigr\}.
$$

これを不等式系で書くと：
$$
\begin{cases}
i - i' = 0,\\
j - j' = 0,\\
k' - k - 1 = 0,\\
0 \le i < N,\;0 \le j < M,\;0 \le k < K-1,\;0 \le k' < K.
\end{cases}
$$

WAR（書き→読み）やWAW（書き→書き）の依存も同様に定義できます。

**依存種類のまとめ**
- 真の依存 (RAW): 前の書き込み結果を次の読み込みが利用される流れ依存
- アンチ依存 (WAR): 読み込み後に同じアドレスへ書き込む順序制約
- 出力依存 (WAW): 同一アドレスへの複数書き込みの順序制約

---

## 5. スケジュール関数 $\Theta$（時間制約）  
各反復 $\vec{x}$ に「論理実行時刻」を割り当てる線形関数：
$$
\Theta(i,j,k) = \theta_1\,i + \theta_2\,j + \theta_3\,k + t_0.
$$
元の i→j→k 順序であれば辞書式順序そのままに $\Theta(i,j,k)=(i,j,k)$ と考えられます。

**合法性条件**：任意の依存 $(\vec{x},\vec{x}')\in R$ について
$$
\Theta(\vec{x}) \;<\; \Theta(\vec{x}') 
$$
を満たさねばなりません。これによりデータ依存を壊さずにループを再順序化できます。

---

## 6. ループ変換の数学的表現  
- **ループ交換（Interchange）**  
  $\Theta$ の重みベクトル $(\theta_1,\theta_2,\theta_3)$ を入れ替えるだけで実現。  
  例えば j→k→i 順序にしたければ $\Theta(i,j,k)=(j,k,i)$ と定義します。

- **ループタイル（Tiling）**  
  タイルサイズ $T_i,T_j,T_k$ を導入し、  
  $$
    i = I\cdot T_i + i',\quad
    0\le i'<T_i
  $$
  と分解。これをスケジュール関数に組み込むことでブロック単位の実行順序を生成します。

- **最適化探索**  
  ISL や Polly では、これらの線形制約（依存条件＋スケジュール順序）を整数線形計画問題（ILP）として定式化し、最適な $\Theta$ を求めます。

---

以上が多面体モデルによるループ依存解析とループ変換の数学的な骨格です。次回はこれを踏まえて実際の ISL コードや具体的な変換例（タイル化後のループ構造など）を見ながら解説しましょう。もしまずここで補足が欲しい点があれば教えてください。
