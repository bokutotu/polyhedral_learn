### 多面体モデル ― **2 ステートメント融合判定** 汎用マニュアル  

---

## 0. 前置き：登場人物（早見表）

| 記号 | ひとことで | きっちり定義 |
|------|------------|--------------|
| `Sₐ`, `Sᵦ` | 解析対象の 2 ステートメント | 固有タグ σ=0 (=Sₐ)、σ=1 (=Sᵦ) |
| **パラメータ** `p` | ループ長など問題サイズ | 整数ベクトル `p∈ℤᴺ` |
| **反復ベクトル** `x` | 1 回のループ実行 | `x = (i₁,…,i_d, σ) ∈ ℤ^{d+1}` |
| **アクセス写像** `f_X` | “この反復は配列 X のここを触る” | 線形写像→ ℤᵈ (配列次元) |
| **スケジュール** `Θ` | “この反復はいつ走る” | 線形写像→ ℤᵏ (時刻ベクトル) |
| **距離ベクトル** `Δ` | `Θ(sink) – Θ(source)` | 依存が守れるかを判定 |

---

## 1. パラメータ空間 `P`  

> **概念**：問題サイズは自由に変えられる変数だが、  
>      “負のサイズ” はあり得ない。そこで **不等式集合** で一括表現する。

### 定義
$$
\boxed{\;
P = \bigl\{\,\mathbf{p}\in\mathbb Z^{n_p}\;\big|\;A_P\,\mathbf{p}\;\ge\;\mathbf{0}\bigr\}
\;}
$$

| 記号 | 定義 |
|------|------|
| `p ∈ ℤ^{n_p}` | 例：`p = (N,M,K)` |
| `A_P ∈ ℤ^{m_P×n_p}` | **パラメータ制約行列**。<br>各行が 1 本の不等式 (≥0) を表す。<br>例：`N ≥ 1` は行 `(−1,0,0)` |
| `≥` | 成分ごと比較（ベクトル不等式） |

---

## 2. 反復ドメイン `D`  

### 2-A. 反復ベクトル（座標）
$$
x = (i_1,\dots,i_d,\sigma)\quad
\bigl(d = \text{ループ深さ},\;\sigma\in\{0,1\}\bigr)
$$

### 2-B. **ステートメントごとの集合**

$$
\boxed{\;
D_{S_\sigma}=\bigl\{\,x\mid A_\sigma\,x'\;\ge\;b_\sigma(\mathbf{p})\bigr\}
\;}
$$

| 記号 | 定義 |
|------|------|
| `x' = (i₁,…,i_d)` | ループ変数だけを抜いた d 次元ベクトル |
| `A_σ ∈ ℤ^{m_σ×d}` | **ループ境界行列**。各行 = 1 本の不等式係数 |
| `b_σ(p) ∈ ℤ^{m_σ}` | **右辺ベクトル**。パラメータ依存可<br>例：`i₁ ≤ N−1` → 行 `(1,0,…,0)` と成分 `N−1` |
| `σ=0/1` | 0=Sₐ, 1=Sᵦ |

> *つまり**A_σ x' ≥ b_σ** が “for ループ条件” を機械的に書き下したもの。*

---

## 3. アクセス写像 `f_X`  

> **概念**：反復ベクトル x が **配列 X のどの要素** `(k₁,…,k_r)`  
>      に触るかを **整数線形写像** で表す。

### 定義
$$
\boxed{\;
f^{R/W}_{X,\sigma}(x)=F_{X,\sigma}\,x'+c_{X,\sigma}
\;}
$$

| 記号 | 定義 |
|------|------|
| `F_{X,σ} ∈ ℤ^{r×d}` | “ループ変数 → 配列添字” 係数行列 |
| `c_{X,σ} ∈ ℤ^r` | 定数オフセット（パラメータ依存可） |
| `R/W` | R=Read，W=Write を別々に用意 |

*例*: `tmp[i-1][j]` in Sᵦ  
→ `r=2`, `F = [[1,0], [0,1]]`, `c = (−1,0)`.

---

## 4. 依存多面体 `R` （Write→Read を例示）

$$
R^{\text{RAW}}
= \Bigl\{\bigl(x_{\text{src}},x_{\text{snk}}\bigr)\;\bigl|\;
   f^{W}_{X,0}(x_{\text{src}})=f^{R}_{X,1}(x_{\text{snk}})\Bigr\}
$$

- **source** = producer `(σ=0)`  
- **sink**   = consumer `(σ=1)`  
- 同じ配列 X で等しい添字が一致 → データを受け渡す

WAR / WAW も同型で定義。

---

## 5. スケジュール関数 `Θ`

$$
\boxed{\;
\Theta(x)=M\,
\begin{pmatrix}x'\\[2pt]\sigma\end{pmatrix}
+ c_\Theta
\;}
$$

| 記号 | 定義 |
|------|------|
| `M ∈ ℤ^{k×(d+1)}` | **スケジュール行列**（ユーザが設計、ISL が探索） |
| `c_Θ ∈ ℤ^k` | 任意定数（通常ゼロ） |
| `k` | タイムスタンプの長さ（≥ 1） |

#### 代表例  
| 目的 | スケジュール例 |
|------|---------------|
| **完全融合候補** | `Θ_fuse(x) = (i₁,…,i_d, σ)` |
| **行方向 1 段スキュー** | `Θ_skew(x) = (i₁+σ, i₂,…,i_d, σ)` |

辞書式で小さい `Θ` が先に実行。

---

## 6. 距離ベクトル `Δ` と合法性

$$
\boxed{\;
\Delta(r)=\Theta(x_{\text{snk}})-\Theta(x_{\text{src}})
\;}
$$

- **合法判定**  
  $$
  \text{最初に非ゼロとなる成分} > 0
  \quad\Longleftrightarrow\quad
  依存を壊さない
  $$

負なら **sink が先に走る** → 不合法。  
0 が並び最後まで 0 なら “同時刻” → 追加次元で順序づけ必須。

---

## 7. 手順フローチャート

| # | 作業内容 | 出力 |
|---|----------|------|
| 1 | 問題サイズを行列 `A_P` で **パラメータ空間 P** にする | `P` |
| 2 | 各ステートメントの for 条件 → 行列 `A_σ`, 右辺 `b_σ` | `D_{Sₐ}, D_{Sᵦ}` |
| 3 | すべてのアクセスを `F_{X,σ}, c_{X,σ}` で線形写像化 | 写像集合 |
| 4 | ISL/Polly で **依存多面体 R** を自動生成 | `R` |
| 5 | 目標スケジュール `Θ` を行列 `M` として仮定 | `Θ` |
| 6 | 依存ごとに `Δ = Θ(sink) − Θ(source)` を計算 | 距離集合 |
| 7 | Δ 判定：負 → **融合不可**；0 → **追加スキュー/タグ**；正 → OK | 融合の可否 |

