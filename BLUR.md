### Blur カーネル ― GEMM と **同じ書式**で一からやり直し  
（**各語を登場順に定義**／数式は整数座標だけ）

| **凡例** | **意味** |
|-----------|----------|
| `S₁` | 横方向 3 点平均（A → tmp） |
| `S₂` | 縦方向 3 点平均（tmp → B） |
| **source** | データを書いた側（producer） |
| **sink** | そのデータを読む／書く側（consumer） |

---

## 1. パラメータ空間 \(P\)
$$
P = \{\, (N,M) \in \mathbb Z_{>0}^2 \,\}
$$

---

## 2. 反復ドメイン \(D\)  
反復ベクトルを  
$$
\vec{x}=(i,j,\sigma)\qquad
\bigl(\sigma=0\!:\!S₁,\;\sigma=1\!:\!S₂\bigr)
$$

$$
\begin{aligned}
D_{S1} &= \{\, (i,j,0)\mid 0\le i<N,\;1\le j<M-1 \,\},\\
D_{S2} &= \{\, (i,j,1)\mid 1\le i<N-1,\;1\le j<M-1 \,\}.
\end{aligned}
$$

---

## 3. アクセス写像（線形写像）  

| Stmt | 配列 | R/W | 写像 | 
|------|------|-----|------|
| S₁ | `A`   | R | $(i,j-1),\,(i,j),\,(i,j+1)$ |
| S₁ | `tmp` | **W** | $(i,j)$ |
| S₂ | `tmp` | **R** | $(i-1,j),\,(i,j),\,(i+1,j)$ |
| S₂ | `B`   | **W** | $(i,j)$ |

---

## 4. 依存多面体 \(R\)

> *ここでは **RAW 依存**（Write→Read）のみ必要*。  

$$
R = R_{\text{center}} \cup R_{\text{up}} \cup R_{\text{down}}
$$

| 名称 | 定義（source → sink） | 行オフセット |
|------|----------------------|--------------|
| center | $(i,j,0) \to (i,j,1)$ | $0$ |
| up     | $(i,j,0) \to (i+1,j,1)$ | $+1$ |
| down   | $(i,j,0) \to (i-1,j,1)$ | $−1$ |

---

## 5. スケジュール関数 \(\Theta\)

$$
\Theta:\mathbb Z^3 \longrightarrow \mathbb Z^3,\quad
\Theta(i,j,\sigma)=\bigl(t_1,t_2,t_3\bigr)
$$

- **意味**：\((t_1,t_2,t_3)\) は「実行時刻ベクトル」。  
- **辞書式順序**：左成分から比較し，小さい方を先に実行。

### 5-A. 素朴案  
$$
\Theta_{\text{naïve}}(i,j,\sigma)=\bigl(i,\;j,\;\sigma\bigr)
$$

### 5-B. スキュー案（後で使う）  
$$
\Theta_{\text{skew}}(i,j,\sigma)=\bigl(i+\sigma,\;j,\;\sigma\bigr)
$$

---

## 6. 距離ベクトル \(\Delta\) ― 定義と計算

$$
\boxed{\;
\Delta(\vec{x}\!\to\!\vec{x}') = \Theta(\vec{x}') - \Theta(\vec{x})
\;}
$$

> - **source** = 左辺（書き手）、**sink** = 右辺（読み手）  
> - 成分差を取るだけ。  

### 6-A. 素朴案での Δ  

| 依存 | $\Delta_{\text{naïve}}$ | 先頭符号 | 合法？ |
|------|------------------------|-----------|--------|
| center | $(0,0,+1)$ | ＋ | ✔ |
| up     | $(+1,0,+1)$ | ＋ | ✔ |
| down   | $(\color{red}{-1},0,+1)$ | － | **✘** |

**結論**：素朴順序では `down` が負 → **融合不可**。

### 6-B. スキュー案での Δ  

| 依存 | $\Delta_{\text{skew}}$ | 先頭非ゼロの符号 | 合法？ |
|------|----------------------|------------------|--------|
| center | $(+1,0,+1)$ | ＋ | ✔ |
| up     | $(+2,0,+1)$ | ＋ | ✔ |
| down   | $(0,0,+1)$  | (1 番目=0,2 番目=0,3 番目=＋) | ✔ |

**結論**：3 依存すべて辞書式で正 ⇒ **スキュー付きなら融合可能**。

---

## 7. まとめフロー

1. **反復ベクトル** \((i,j,\sigma)\) を採用  
2. **依存多面体** 3 種 (center/up/down) を列挙  
3. **Θ** を当てはめ、\(\Delta=\Theta_{\text{sink}}-\Theta_{\text{source}}\) を計算  
4. **最初の非ゼロ成分が正** → 依存維持  
5. 素朴 Θ で負が出る ⇒ **失敗**  
6. **i 軸へ +σ スキュー** で Δ を非負化 ⇒ **成功**  
